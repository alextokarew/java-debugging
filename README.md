# java-debugging
Java debugging examples

TODO: investigate gradle run option `--debug-jvm`

# JDB examples

# Multithreaded applications debugging

# Code generation debugging

## Working with autogenerated Java code compiled using Janino

Launch Spark shell in the first terminal

```bash
export JAVA_TOOL_OPTIONS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5006"
./bin/spark-shell --driver-java-options "-Dorg.codehaus.janino.source_debugging.enable=true" --conf spark.sql.ui.explainMode=codegen
```
Launch JDB in the second terminal

```bash
jdb -attach localhost:5006
```

```scala
val df = spark.range(1, 1000).select($"id", ($"id" * 3).as("triple"))
df.groupBy(($"triple" + 6) % 15).count().collect()
```

```jdb
stop  at org.apache.spark.sql.execution.WholeStageCodegenEvaluatorFactory$WholeStageCodegenPartitionEvaluator.eval

next
eval code.body
next (until 47 line)
step
eval buffer.getClass()
stop thread at org.apache.spark.sql.catalyst.expressions.GeneratedClass$GeneratedIteratorForCodegenStage1.init
stepi
dump this
```

## Autogenerated bytecode debugging

Специальная сборка OpenJDK с включённой отладочной поддержкой (./configure --enable-debug) предоставляет мощные JVM флаги:
`-XX:+TraceBytecodes`

### With JDB

```commandline
jdb -sourcepath app/src/main/java:app/src/main/exprs \
    -classpath app/build/classes/java/main/ \
    com.github.alextokarew.javadebugging.codegen.BytecodeDebugging
```

```jdb
stop at com.github.alextokarew.javadebugging.codegen.BytecodeDebugging:37
run 

stepi (x4)
wherei

list
```

# FFM API debugging

## Building and running
At the project root:
```bash
./gradlew clean build
./gradlew :app:run -Dexec.mainClass=com.github.alextokarew.javadebugging.ffm.FibFFM
```

```
gcc -g -o0 -shared -fpic -o libfibffm.so -I${JAVA_HOME}/include -I${JAVA_HOME}/include/linux fibffm.cpp

javac -g --enable-preview --release 21 com/github/alextokarew/joker/jvmdebug/FibFFM.java
java --enable-preview --enable-native-access=ALL-UNNAMED com.github.alextokarew.javadebugging.ffm.FibFFM

java --enable-preview --enable-native-access=ALL-UNNAMED -agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5005 com.github.alextokarew.javadebugging.ffm.FibFFM
```
